<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Crafty Web Console</title>
<style>
  body {
    margin: 0; font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    background: #121212; color: #eee;
  }
  header { padding: 20px; text-align:center; background:#1f1f1f; font-size:1.8rem; font-weight:bold; letter-spacing:1px; }
  .container { display: flex; flex-wrap: wrap; padding:20px; gap:20px; }
  .card { background:#1e1e2e; border-radius:12px; padding:20px; flex:1 1 300px; max-width:600px; box-shadow:0 5px 20px rgba(0,0,0,0.5); }
  .card h2 { margin-top:0; }
  button { padding:8px 14px; margin:4px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
  .btn-start { background:#18b659; color:#fff; }
  .btn-stop { background:#d32f2f; color:#fff; }
  .btn-restart { background:#f1c40f; color:#000; }
  input, textarea { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:none; background:#2a2a3d; color:#eee; font-family:monospace; }
  #console { height:300px; overflow:auto; background:#111; padding:10px; border-radius:8px; font-family:monospace; font-size:0.9rem; white-space:pre-wrap; }
  ul.players { padding:0; list-style:none; max-height:300px; overflow:auto; }
  ul.players li { padding:6px; border-radius:6px; background:#2a2a3d; margin-bottom:4px; }
  @media(max-width:880px){ .container { flex-direction: column; } }
</style>
</head>
<body>

<header>Crafty Web Console</header>

<!-- LOGIN FORM -->
<div id="login" class="card" style="max-width:400px;margin:40px auto;">
  <h2>Login</h2>
  <input type="text" id="username" placeholder="Crafty Username">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <p id="loginMsg" style="color:#f55;"></p>
</div>

<!-- PANEL -->
<div id="panel" class="container" style="display:none;">
  <div class="card">
    <h2>Server Control</h2>
    <p>Status: <span id="status">Loading...</span></p>
    <button class="btn-start" onclick="sendAction('start')">Start</button>
    <button class="btn-stop" onclick="sendAction('stop')">Stop</button>
    <button class="btn-restart" onclick="sendAction('restart')">Restart</button>
  </div>

  <div class="card">
    <h2>Players Online</h2>
    <ul id="players">Loading...</ul>
  </div>

  <div class="card" style="flex:1 1 100%;">
    <h2>Console</h2>
    <div id="console">Loading logs...</div>
    <input type="text" id="command" placeholder="Enter Minecraft command">
    <button onclick="sendCommand()">Send Command</button>
  </div>
</div>

<script>
  // ================= CONFIG =================
  const apiUrl = "https://blockservers.net/api"; // Crafty API URL
  const serverId = 1; // usually 1 if only one server
  let token = null;    // JWT token after login
  // =========================================

  async function login() {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;
    if(!user || !pass){ document.getElementById("loginMsg").innerText="Enter username & password"; return; }

    try {
      const res = await fetch(`${apiUrl}/auth/login`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({username:user,password:pass})
      });
      if(!res.ok) throw new Error("Login failed");
      const data = await res.json();
      token = data.token;
      document.getElementById("login").style.display = "none";
      document.getElementById("panel").style.display = "flex";
      fetchStatus();
      fetchLogs();
      setInterval(fetchStatus,10000);
      setInterval(fetchLogs,2000);
    } catch(e) {
      document.getElementById("loginMsg").innerText="❌ Invalid credentials";
      console.error(e);
    }
  }

  async function fetchStatus() {
    try {
      const res = await fetch(`${apiUrl}/servers`,{ headers:{ "Authorization":`Bearer ${token}` }});
      const data = await res.json();
      const server = data.servers[0];
      document.getElementById("status").innerText = server.running ? "✅ Online" : "❌ Offline";
      updatePlayers(server.players);
    } catch(e){
      document.getElementById("status").innerText = "⚠️ Error fetching status";
      console.error(e);
    }
  }

  function updatePlayers(players) {
    const list = document.getElementById("players");
    list.innerHTML = "";
    if(players.length){
      players.forEach(p=>{ const li=document.createElement("li"); li.innerText=p; list.appendChild(li); });
    } else list.innerHTML = "<li>No players online</li>";
  }

  async function sendAction(action){
    try {
      await fetch(`${apiUrl}/servers/${serverId}/${action}`,{ method:"POST", headers:{ "Authorization":`Bearer ${token}` }});
      fetchStatus();
    } catch(e){ console.error(e); }
  }

  async function fetchLogs(){
    try {
      const res = await fetch(`${apiUrl}/servers/${serverId}/logs`,{ headers:{ "Authorization":`Bearer ${token}` }});
      const data = await res.json();
      const consoleEl = document.getElementById("console");
      consoleEl.innerText = data.logs.join("\n");
      consoleEl.scrollTop = consoleEl.scrollHeight;
    } catch(e){ console.error(e); }
  }

  async function sendCommand() {
    const cmd = document.getElementById("command").value;
    if(!cmd) return;
    try {
      await fetch(`${apiUrl}/servers/${serverId}/command`,{
        method:"POST",
        headers:{ "Authorization":`Bearer ${token}`,"Content-Type":"application/json" },
        body: JSON.stringify({command:cmd})
      });
      document.getElementById("command").value = "";
      fetchLogs();
    } catch(e){ console.error(e); }
  }
</script>

</body>
</html>
